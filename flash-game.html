<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Play Flash Game — Diagnostic Player</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#0b1220cc;
      --accent:#38bdf8;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#fb7185;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Arial,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header{
      padding:14px 18px;
      background:var(--panel);
      border-bottom:1px solid rgba(30,41,59,0.9);
      display:flex;
      gap:12px;
      align-items:center;
    }

    header h1{
      margin:0;
      font-size:16px;
      color:var(--accent);
    }

    #note{
      margin-left:auto;
      color:var(--muted);
      font-size:13px;
    }

    main{
      flex:1;
      display:flex;
      gap:12px;
      padding:12px;
      align-items:flex-start;
      justify-content:center;
    }

    #player-wrap{
      width:100%;
      max-width:1100px;
      height:calc(100vh - 220px);
      background:#000;
      border-radius:8px;
      overflow:hidden;
      border:1px solid rgba(30,41,59,0.9);
      display:flex;
      flex-direction:column;
    }

    /* When in fullscreen, let the player-wrap fill the screen */
    :fullscreen #player-wrap,
    :-webkit-full-screen #player-wrap,
    :-moz-full-screen #player-wrap {
      width:100vw;
      height:100vh;
      max-width:none;
      border-radius:0;
    }

    #ruffle-container{
      width:100%;
      height:100%;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .sidebar{
      width:360px;
      max-width:40%;
      min-width:260px;
      background:var(--panel);
      border-radius:8px;
      padding:12px;
      border:1px solid rgba(30,41,59,0.9);
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .sidebar h3{margin:6px 0 8px 0;color:#7dd3fc}
    .sidebar pre{white-space:pre-wrap;color:var(--muted);background:transparent;padding:6px 0;margin:6px 0;border-radius:4px}
    .controls{
      padding:12px;
      background:var(--panel);
      border-top:1px solid rgba(30,41,59,0.9);
      display:flex;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
    }

    .btn{
      padding:8px 12px;
      background:rgba(30,41,59,0.95);
      color:var(--text);
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-size:14px;
    }

    .btn:active{transform:translateY(1px)}
    .status-ok{color:#86efac}
    .status-warn{color:#fbbf24}
    .status-bad{color:var(--danger)}

    .fallback{
      color:var(--muted);
      padding:14px;
      text-align:left;
      line-height:1.4;
    }

    a.link{color:var(--accent);text-decoration:underline}

    @media (max-width:920px){
      main{flex-direction:column;align-items:stretch}
      .sidebar{max-width:100%;width:auto}
      #player-wrap{height:60vh}
    }
  </style>
</head>
<body>

  <header>
    <h1 id="title">Play Game</h1>
    <div id="note">Initializing player…</div>
  </header>

  <main>
    <div id="player-wrap" role="main" aria-live="polite">
      <div id="ruffle-container" aria-label="Flash player container">
        <div style="color:#9ca3af;padding:12px">Preparing player…</div>
      </div>
      <div class="controls" role="toolbar" aria-label="Player controls">
        <button id="back" class="btn">Back</button>
        <button id="fullscreen-btn" class="btn" aria-pressed="false">Enter Fullscreen</button>
      </div>
    </div>

    <aside class="sidebar" aria-label="Diagnostics">
      <h3>Diagnostics</h3>
      <div><strong>SWF path</strong></div>
      <pre id="swf-path">—</pre>

      <div><strong>HEAD check</strong></div>
      <pre id="head-result">waiting…</pre>

      <div><strong>Ruffle script attempted</strong></div>
      <pre id="script-attempt">waiting…</pre>

      <div><strong>Ruffle status</strong></div>
      <pre id="ruffle-status">waiting…</pre>

      <div><strong>Player errors</strong></div>
      <pre id="diag">waiting…</pre>

      <div style="margin-top:8px">
        <strong>Troubleshooting tips</strong>
        <ul style="padding-left:18px;margin:6px 0;color:var(--muted)">
          <li>Serve via http://localhost:8000 not file://</li>
          <li>Use local ruffle/ruffle.js to avoid CDN blocks</li>
          <li>Disable script blockers or test in Incognito</li>
          <li>If SWF is AS3, try Flashpoint or the projector</li>
        </ul>
      </div>
    </aside>
  </main>

  <!-- The page will prefer a local ruffle/ruffle.js if present, otherwise fallback to CDN -->
  <script>
    (function(){
      function qs(name){ return new URLSearchParams(location.search).get(name); }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

      const file = qs('file');
      const rawTitle = qs('title');
      const title = rawTitle ? decodeURIComponent(rawTitle).replace(/\+/g,' ') : (file || 'Game');
      document.getElementById('title').textContent = title;

      const note = document.getElementById('note');
      const swfPathEl = document.getElementById('swf-path');
      const headResultEl = document.getElementById('head-result');
      const scriptAttemptEl = document.getElementById('script-attempt');
      const ruffleStatusEl = document.getElementById('ruffle-status');
      const diagEl = document.getElementById('diag');
      const playerContainer = document.getElementById('ruffle-container');
      const playerWrap = document.getElementById('player-wrap');

      const backBtn = document.getElementById('back');
      const fullscreenBtn = document.getElementById('fullscreen-btn');

      backBtn.addEventListener('click', ()=> location.href = 'index.html');

      fullscreenBtn.addEventListener('click', toggleFullscreen);

      // keyboard: F11 or "f" toggles fullscreen for convenience
      document.addEventListener('keydown', (e) => {
        if (e.key === 'F11' || e.key === 'f' || e.key === 'F') {
          e.preventDefault();
          toggleFullscreen();
        }
      });

      // update button state when fullscreen changes (handles ESC)
      document.addEventListener('fullscreenchange', updateFullscreenButton);
      document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
      document.addEventListener('mozfullscreenchange', updateFullscreenButton);

      function updateFullscreenButton(){
        const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement);
        fullscreenBtn.textContent = isFs ? 'Exit Fullscreen' : 'Enter Fullscreen';
        fullscreenBtn.setAttribute('aria-pressed', String(isFs));
      }

      function toggleFullscreen(){
        const doc = document;
        const fsElement = doc.fullscreenElement || doc.webkitFullscreenElement || doc.mozFullScreenElement;
        if (fsElement){
          if (doc.exitFullscreen) doc.exitFullscreen();
          else if (doc.webkitExitFullscreen) doc.webkitExitFullscreen();
          else if (doc.mozCancelFullScreen) doc.mozCancelFullScreen();
        } else {
          // prefer making the player-wrap fullscreen for consistent UI
          const el = playerWrap;
          if (el.requestFullscreen) el.requestFullscreen();
          else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
          else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
        }
      }

      if (!file){
        swfPathEl.textContent = 'No file parameter';
        headResultEl.textContent = 'No SWF specified in URL. Use ?file=your.swf';
        ruffleStatusEl.textContent = 'Idle';
        note.textContent = 'No SWF specified';
        playerContainer.innerHTML = `<div class="fallback">No SWF specified. Return to the game list.</div>`;
        return;
      }

      const swfPath = `flash-games/${file}`;
      swfPathEl.textContent = swfPath;
      note.textContent = 'Checking SWF availability…';

      // HEAD check
      fetch(swfPath, { method: 'HEAD' })
        .then(res => {
          headResultEl.textContent = `HTTP ${res.status} ${res.statusText}\nContent-Type: ${res.headers.get('content-type')}\nContent-Length: ${res.headers.get('content-length') || 'unknown'}`;
          if (!res.ok) throw new Error(`SWF HEAD returned ${res.status}`);
          note.textContent = 'SWF found. Loading Ruffle…';
          return loadRuffleLocalOrCdn();
        })
        .then(scriptUrl => {
          scriptAttemptEl.textContent = scriptUrl;
          ruffleStatusEl.textContent = 'Script loaded. Waiting for RufflePlayer…';
          return waitForRuffle(4000);
        })
        .then(() => {
          ruffleStatusEl.textContent = 'RufflePlayer available. Creating player…';
          return instantiatePlayer();
        })
        .then(() => {
          ruffleStatusEl.textContent = 'Player instantiated. Loading SWF…';
          note.textContent = '';
        })
        .catch(err => {
          console.error(err);
          diagEl.textContent = String(err);
          ruffleStatusEl.textContent = 'Failed';
          note.textContent = 'Playback unavailable';
          showFallback(String(err));
        });

      // Try local ruffle first, fallback to CDN
      function loadRuffleLocalOrCdn(){
        return new Promise((resolve, reject) => {
          // check local ruffle presence
          fetch('ruffle/ruffle.js', { method: 'HEAD', cache: 'no-store' })
            .then(r => {
              if (r.ok){
                appendScript('ruffle/ruffle.js', resolve, reject);
              } else {
                appendScript('https://unpkg.com/@ruffle-rs/ruffle/dist/ruffle.js', resolve, reject);
              }
            })
            .catch(() => {
              appendScript('https://unpkg.com/@ruffle-rs/ruffle/dist/ruffle.js', resolve, reject);
            });
        });
      }

      function appendScript(src, resolve, reject){
        if (window.RufflePlayer){
          scriptAttemptEl.textContent = `skipped load, RufflePlayer already present`;
          return resolve(src);
        }
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => {
          scriptAttemptEl.textContent = src + ' (loaded)';
          resolve(src);
        };
        s.onerror = (e) => {
          scriptAttemptEl.textContent = src + ' (failed)';
          reject(new Error('Failed to load script: ' + src));
        };
        document.head.appendChild(s);
      }

      function waitForRuffle(timeout){
        return new Promise((resolve, reject) => {
          let waited = 0;
          const interval = setInterval(() => {
            if (window.RufflePlayer){
              clearInterval(interval);
              resolve();
            } else {
              waited += 100;
              if (waited >= timeout){
                clearInterval(interval);
                reject(new Error('RufflePlayer not available after timeout'));
              }
            }
          }, 100);
        });
      }

      function instantiatePlayer(){
        return new Promise((resolve, reject) => {
          try {
            const ruffle = window.RufflePlayer.newest();
            const player = ruffle.createPlayer();
            player.style.width = '100%';
            player.style.height = '100%';
            player.style.display = 'block';
            player.style.background = '#000';
            playerContainer.innerHTML = '';
            playerContainer.appendChild(player);

            // capture load errors
            const loadResult = player.load(swfPath);
            // player.load may return a promise in newer builds
            if (loadResult && typeof loadResult.then === 'function'){
              loadResult.then(() => {
                diagEl.textContent = 'player.load resolved';
                resolve();
              }).catch(err => {
                diagEl.textContent = 'player.load error: ' + String(err);
                reject(err);
              });
            } else {
              // older API: no promise, assume success but set a short timeout to detect immediate failures
              setTimeout(() => {
                diagEl.textContent = 'player.load started (no promise returned)';
                resolve();
              }, 500);
            }
          } catch (e){
            reject(e);
          }
        });
      }

      function showFallback(message){
        playerContainer.innerHTML = `
          <div class="fallback" role="status" style="padding:18px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">
            <p><strong style="color:var(--danger)">Unable to play with Ruffle:</strong> ${escapeHtml(message)}</p>
            <p>Possible causes: script blocked by an extension or policy, CDN redirect blocked, or SWF uses unsupported Flash features (AS3/AVM2).</p>
            <p><a class="link" href="${encodeURI(swfPath)}" target="_blank" rel="noopener">Open raw file</a></p>
            <p style="margin-top:8px">If the SWF is AS3, try Flashpoint or the standalone Flash Player projector.</p>
          </div>`;
      }

      // capture console.error to surface messages in diagnostics
      (function captureConsole(){
        const origErr = console.error;
        console.error = function(...args){
          try {
            const text = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
            diagEl.textContent = (diagEl.textContent && diagEl.textContent !== 'waiting…' ? diagEl.textContent + '\n' : '') + text;
          } catch(e){}
          origErr.apply(console, args);
        };
      })();

    })();
  </script>
</body>
</html>
